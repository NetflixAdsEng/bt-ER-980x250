!(function() {
  var COMPONENT_NAME = 'netflix-img';

  if (window.customElements && window.customElements.define) {
    var ImageComponent = function() {
      var self = Utils.reflectConstruct(HTMLElement, [], this.constructor);
      self._attached = false;
      self._hasInited = false;
      return self;
    };

    ImageComponent.prototype = Object.create(HTMLElement.prototype, {
      disconnectedCallback: {
        value: function() {
          this._attached = false;
        }
      },
      connectedCallback: {
        value: function() {
          var img = document.createElement('img');
          this.appendChild(img);

          this._attached = true;

          if (this._hasInited) {
            return;
          }

          this._hasInited = true;

          var dom = this;
          var img = this.children[0];

          var height = dom.getAttribute('height');
          var width = dom.getAttribute('width');
          if (width) img.setAttribute('width', width);
          if (height) img.setAttribute('height', height);

          var MonetComponent = document.querySelector('monet-integrator');
          if (MonetComponent) {
            MonetComponent.register(this);

            MonetComponent.getMonetData().then(function(data) {
              var imgPath;
              var bindSrc = dom.getAttribute('data-dynamic-key');

              var imgId = dom.getAttribute('id');

              try {
                // absolute paths eg. assets/img.png
                if (/\.(jpe?g|png|gif|svg)$/i.test(bindSrc) || /\.(nflximg.net)/i.test(bindSrc)) {
                  imgPath = bindSrc;
                  img.setAttribute('src', bindSrc);
                } else {
                  imgPath = data.rootAssets['image.' + bindSrc].url;
                  img.setAttribute('src', imgPath);
                }
              } catch (e) {
                MonetComponent.getBackupMonetData().then(
                  function(backupData) {
                    if (backupData.rootAssets['image.' + bindSrc]) {
                      imgPath = backupData.rootAssets['image.' + bindSrc].url;
                      img.setAttribute('src', imgPath);
                    } else {
                      console.warn('Image source incorrectly set!');
                      dom.dispatchEvent(new CustomEvent('ready'));
                    }
                  },
                  function(error) {
                    console.error('Failed to load backup Monet data', error);
                  }
                );
              }

              if (imgId) {
                img.setAttribute('id', imgId + '-img');
              }
            });
          }

          img.onload = img.onerror = function(event) {
            dom.style.width = img.width + 'px';
            dom.style.height = img.height + 'px';
            img.style.position = 'absolute';
            dom.dispatchEvent(new CustomEvent('ready'));
          };
        }
      },

      preview: {
        value: function() {
          var imgPath = '//ae.nflximg.net/monet/img/c20/netflix_placement.svg';
          this.children[0].setAttribute('src', imgPath);
          this.setAttribute('width', 300);
          this.setAttribute('height', 300);
        }
      }
    });

    ImageComponent.prototype.constructor = ImageComponent;
    Object.setPrototypeOf(ImageComponent, HTMLElement);

    if (!customElements.get(COMPONENT_NAME)) {
      customElements.define(COMPONENT_NAME, ImageComponent);
    }
  }
})();
