!(function() {
  // remove any tags, replace <br> with \n and render back to innerHTML
  function safeBRReplace(str) {
    var frag = document.createDocumentFragment();
    frag.textContent = str.replace(/<br\s*\/?>/gm, '\n');
    return frag.textContent.replace(/\n/gm, '<br>');
  }

  if (window.customElements && window.customElements.define) {
    var COMPONENT_NAME = 'netflix-text';

    var TextComponent = function() {
      var self = Utils.reflectConstruct(HTMLElement, [], this.constructor);
      self._attached = false;
      self._hasInited = false;
      return self;
    };

    TextComponent.prototype = Object.create(HTMLElement.prototype, {
      disconnectedCallback: {
        value: function() {
          this._attached = false;
        }
      },
      connectedCallback: {
        value: function() {
          var textSpan = document.createElement('span');
          this.appendChild(textSpan);

          this._attached = true;

          if (this._hasInited) {
            return;
          }

          this._hasInited = true;

          var dom = this;
          var textSpan = this.children[0];

          var MonetComponent = document.querySelector('monet-integrator');
          if (MonetComponent) {
            MonetComponent.register(this);
            MonetComponent.getMonetData().then(function(data) {
              var bindSrc = dom.getAttribute('data-dynamic-key');
              if (bindSrc.split('.').length == 1) {
                bindSrc = 'rootAssets["text.' + bindSrc + '"].text';
              }

              try {
                var dynamicText = eval('data.' + bindSrc);
                if (dynamicText) {
                  textSpan.innerHTML = safeBRReplace(dynamicText);
                  textSpan.classList.add(Monet.getComponentLocale('text.' + dom.getAttribute('data-dynamic-key')).substr(0, 2));
                }

                dom.dispatchEvent(new CustomEvent('ready'));
              } catch (e) {
                console.error('Monet dynamic ID not found in JSON: ', bindSrc, 'trying backup');

                MonetComponent.getBackupMonetData().then(
                  function(backupData) {
                    if (backupData) {
                      var dynamicText = eval('backupData.' + bindSrc);
                      textSpan.innerHTML = safeBRReplace(dynamicText);
                      textSpan.classList.add(
                        Monet.getComponentLocale('text.' + dom.getAttribute('data-dynamic-key')).substr(0, 2)
                      );
                    }
                    dom.dispatchEvent(new CustomEvent('ready'));
                  },
                  function(error) {
                    console.error('Failed to load backup Monet data', error);
                  }
                );
              }
            });
          } else {
            console.warn('No "monet-integrator" component found. Dynamic binding is disabled');
          }
        }
      },

      preview: {
        value: function() {
          this.children[0].innerHTML = 'This is a preview of the text component.';
          // ensure the preview in C2.0 doesn't get cut off
          this.style.height = '40px';
          this.style.display = 'inline-block';
        }
      }
    });

    TextComponent.prototype.constructor = TextComponent;
    Object.setPrototypeOf(TextComponent, HTMLElement);

    if (!customElements.get(COMPONENT_NAME)) {
      customElements.define(COMPONENT_NAME, TextComponent);
    }
  }
})();
