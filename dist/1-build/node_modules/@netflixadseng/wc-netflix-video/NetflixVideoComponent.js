!(function() {
  var COMPONENT_NAME = 'netflix-video';

  // checks for existing Utils from shared / imported Utils methods
  window.Utils = (function(Utils) {
    Utils.tracker = function(s, u, d) {
      if (this.suppressLog) {
        this.suppressLog = false;
        return;
      }
      if (typeof Monet !== 'undefined') {
        Monet.logEvent(s, { url: u, pos: d.time });
      }
      if (typeof Enabler !== 'undefined') {
        switch (s) {
          case 'VIDEO_FIRST_QUART':
            Enabler.counter('VIDEO_FIRST_QUART');
            break;
          case 'VIDEO_SECOND_QUART':
            Enabler.counter('VIDEO_SECOND_QUART');
            break;
          case 'VIDEO_THIRD_QUART':
            Enabler.counter('VIDEO_THIRD_QUART');
            break;
          case 'VIDEO_PLAY':
            Enabler.counter('VIDEO_PLAY');
            break;
          case 'VIDEO_COMPLETE':
            Enabler.counter('VIDEO_COMPLETE');
            break;
          case 'VIDEO_PAUSE':
            Enabler.counter('VIDEO_PAUSE');
            break;
          case 'VIDEO_STOP':
            Enabler.counter('VIDEO_STOP');
            break;
          case 'VIDEO_UNMUTE':
            Enabler.counter('VIDEO_UNMUTE');
            break;
          case 'VIDEO_MUTE':
            Enabler.counter('VIDEO_MUTE');
            break;
        }
      }
    };

    Utils.isAutoplayAvailable = function() {
      if (!this.isMobile) return true;
      if (!this.isiOS) {
        return true;
      } else if (this.isSafari) {
        if (this.isiPad)
          var os = Number(
            navigator.userAgent
              .split('iPad')[1]
              .split(' ')[3]
              .replace('_', '.')
          );
        else
          var os = navigator.userAgent
            .split('iPhone OS ')[1]
            .split(' ')[0]
            .split('_')[0];
        if (os >= 10) return true;
        else return false;
      } else {
        return false;
      }
    };

    Utils.timeFormat = function(time) {
      var sn = parseInt(time, 10);
      var h = Math.floor(sn / 3600);
      var m = Math.floor((sn - h * 3600) / 60);
      var s = sn - h * 3600 - m * 60;
      if (m < 10) {
        m = m;
      }
      if (s < 10) {
        s = '0' + s;
      }
      var t = (m || 0) + ':' + (s || '00');
      return t;
    };

    Utils.hide = function(el) {
      el.classList.add('hide');
    };
    Utils.show = function(el) {
      el.classList.remove('hide');
    };

    return Utils;
  })(window.Utils || {});

  var VideoSource = (function(id, config) {
    function VideoSource(id, config) {
      this._id = id;
      this.id = id;
      this.title = config.sources[id]
        .split('/')
        .pop()
        .split('.')[0];
      this.plays = 0;
      this.completed = 0;
      this.layers = [];
      this.source = config.sources[id];
      this.customControls = config.customControls[id] || false;
      this.controls = config.controls[id] === undefined ? true : config.controls[id];
      this.muted = config.muted[id] || false;
      this.hideOnComplete = config.hideOnComplete[id] || false;
    }

    VideoSource.prototype.hasBeenPlayed = function() {
      return Boolean(this.plays);
    };
    return VideoSource;
  })();

  var NetflixVideo = (function(component, config) {
    function NetflixVideo(component, config) {
      this.component = component;
      this.config = config;
      this.sources = [];
      this.wrapper = document.createElement('div');
      this.closeButton = createCloseButton.call(this);
      this.closeButtonSvg = this.closeButton.getElementsByTagName('svg')[0];
      this.container = document.createElement('div');
      this.container.className = 'netflix-video-container';
      this.clickArea = document.createElement('div');

      this.closeButton.classList.add('close');
      this.clickArea.classList.add('videoClick');
      this.wrapper.classList.add('netflix-video');
      this.wrapper.appendChild(this.container);
      this.wrapper.appendChild(this.clickArea);
      this.wrapper.appendChild(this.closeButton);
      this.component.appendChild(this.wrapper);

      for (var i = 0; i < this.config.sources.length; i++) {
        this.sources.push(new VideoSource(i, this.config));
        this.sources[i].muted = this.config.muted[i];
      }

      this.stopTimer = function() {
        this.playing = false;
        this.component.playing = false;
        clearInterval(this.timer);
        setTimeDisplay.call(this);
      };

      style.call(this);
      buildControls.call(this);
      createPlayer.call(this);

      function createPlayer() {
        var id = 0;
        this.id = id;
        this.video_id = this.component.getAttribute('video_id');

        this.PlayerState = {
          ENDED: 'ended',
          PLAYING: 'loadeddata',
          PAUSED: 'pause',
          CUED: 'loadstart',
          BUFFERING: 'play',
          LOADED: 'loadeddata',
          VOLUME: 'volumechange'
        };

        this._video = document.createElement('video');
        this._video.width = this.config.size[id] ? this.config.size[id].width : this.config.size[0].width;
        this._video.height = this.config.size[id] ? this.config.size[id].height : this.config.size[0].height;

        this._video.addEventListener('ended', onStateChanged.bind(this));
        this._video.addEventListener('play', onStateChanged.bind(this));
        this._video.addEventListener('pause', onStateChanged.bind(this));
        this._video.addEventListener('volumechange', onStateChanged.bind(this));
        this._video.addEventListener('loadeddata', onStateChanged.bind(this));

        this.spinner = document.createElement('div');
        this.wrapper.insertBefore(this.spinner, this.wrapper.firstChild);
        this.spinner.classList.add('spinner');
        this.spinner.innerHTML =
          '<svg width="38" height="38" viewBox="0 0 38 38" xmlns="http://www.w3.org/2000/svg"> <defs> <linearGradient x1="8.042%" y1="0%" x2="65.682%" y2="23.865%" id="a"> <stop stop-color="#fff" stop-opacity="0" offset="0%"/> <stop stop-color="#fff" stop-opacity=".631" offset="63.146%"/> <stop stop-color="#fff" offset="100%"/> </linearGradient> </defs> <g fill="none" fill-rule="evenodd"> <g transform="translate(1 1)"> <path d="M36 18c0-9.94-8.06-18-18-18" id="Oval-2" stroke="url(#a)" stroke-width="2"> <animateTransform attributeName="transform" type="rotate" from="0 18 18" to="360 18 18" dur="0.9s" repeatCount="indefinite"/> </path> <circle fill="#fff" cx="36" cy="18" r="1"> <animateTransform attributeName="transform" type="rotate" from="0 18 18" to="360 18 18" dur="0.9s" repeatCount="indefinite"/> </circle> </g> </g></svg>';
        Utils.createStyle.call(
          this.component,
          COMPONENT_NAME,
          '.spinner',
          'position:absolute;top:50%;left:50%;width:38px;height:38px;transform:translate(-50%,-50%)'
        );

        this._video.removeAttribute('controls');
        this.container.appendChild(this._video);
        this.video = {
          cueVideoById: function(src) {
            var htmlElem = document.getElementsByTagName('html')[0];
            var isInception = htmlElem.hasAttribute('monet-inception-pristine-element');
            if (typeof Enabler !== 'undefined' && !isInception) {
              this._video.src = Enabler.getUrl(src);
            } else {
              this._video.src = src;
            }
          }.bind(this),
          getDuration: function() {
            return this._video.duration;
          }.bind(this),
          getCurrentTime: function() {
            return this._video.currentTime;
          }.bind(this),
          isMuted: function() {
            return this._video.muted;
          }.bind(this),
          pauseVideo: function() {
            this._video.pause();
          }.bind(this),
          playVideo: function() {
            // if (!Utils.isMobile)
            this._video.play();
          }.bind(this),
          unMute: function() {
            this._video.muted = false;
          }.bind(this),
          mute: function() {
            this._video.muted = true;
          }.bind(this),
          seekTo: function(t) {
            this._video.currentTime = t;
          }.bind(this)
        };

        this.resize();
        setEvents.call(this);
        this.hide();

        if (Utils.isAutoplayAvailable() && this.config.autoplay === true) {
          if (typeof gwd != 'undefined') {
            this.show();
            this.setSource(0);
            this._video.setAttribute('autoplay', '');
            if (Utils.isMobile) {
              this._video.setAttribute('playsinline', '');
              this._video.setAttribute('muted', '');
            }
          } else {
            this.play(0);
          }
        }

        if (typeof Enabler != 'undefined')
          Enabler.loadModule(
            studio.module.ModuleId.VIDEO,
            function() {
              studio.video.Reporter.attach('Video ' + this.video_id, this._video);
            }.bind(this)
          );
      }

      function style() {
        Utils.createStyle.call(
          this.component,
          COMPONENT_NAME,
          '.hide',
          'border: 0 !important;clip: rect(0 0 0 0) !important;height: 1px !important;margin: -1px !important;overflow: hidden !important;padding: 0 !important;position: absolute !important;width: 1px !important;',
          ['.hide', true],
          'border: 0 !important;clip: rect(0 0 0 0) !important;height: 1px !important;margin: -1px !important;overflow: hidden !important;padding: 0 !important;position: absolute !important;width: 1px !important;',
          '.netflix-video',
          'background-color:#000; position: absolute; top: 0; left: 0;',
          '.netflix-video .netflix-video-container',
          'position:absolute;top:0;left:0;',
          '.netflix-video .videoClick',
          'position:absolute;top:0;left:0;cursor:pointer;width:100%;height:100%;background:url(data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7);',
          '.netflix-video .close',
          'position:absolute;top:10px;left:10px;z-index:15;cursor:pointer;width:' +
            this.config.closeButtonSize +
            'px;height:' +
            this.config.closeButtonSize +
            'px;overflow:hidden;',
          '.netflix-video .videoPanels',
          'width:100%;height:100%;position:absolute;pointer-events:none;',
          '.netflix-video .iVideoPanels',
          'width:0;height:0;position:absolute;',
          '.netflix-video .controls',
          'z-index:12;position:absolute;bottom:1px;width:100%;',
          '.netflix-video .playButton.v_icon',
          'margin-left:5px;',
          '.netflix-video .v_icon',
          'width:25px;height:25px;float:left;cursor:pointer;',
          '.netflix-video .timer',
          'float:left;font-family:Arial,sans-serif;font-weight:700;font-size:12px;letter-spacing:1px;text-shadow:0 1px 2px rgba(0,0,0,.5);line-height:26px;margin-left:9px;pointer-events:none;'
        );
      }

      function svgButton(id, hover) {
        var i = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        i.setAttribute('width', '25px');
        i.setAttribute('height', '25px');
        i.setAttribute('viewBox', '0 0 50 50');
        i.id = id || '';
        i.hover = hover;
        return i;
      }

      function createCloseButton() {
        var w = 20;
        var wrapper = document.createElement('div');
        var i = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        i.setAttribute('width', w + 'px');
        i.setAttribute('height', w + 'px');
        i.fill = new Utils.SvgIcon(
          'closeButtonFill',
          'M0,' + w / 2 + 'a' + w / 2 + ',' + w / 2 + ' 0 1,0 ' + w + ',0a' + w / 2 + ',' + w / 2 + ' 0 1,0 -' + w + ',0',
          this.config.closeColors[0]
        );
        var a = Math.round(w * 0.7);
        var b = w - a;
        i.cross = new Utils.SvgIcon(
          'line1',
          'M' + b + ' ' + b + ' L' + a + ' ' + a + ' M' + a + ' ' + b + ' L' + b + ' ' + a + ''
        );
        i.cross.setAttribute('stroke', this.config.closeColors[1]);
        i.cross.setAttribute('stroke-width', w < 15 ? 1 : 2);
        i.appendChild(i.fill);
        i.appendChild(i.cross);

        wrapper.appendChild(i);
        return wrapper;
      }

      function buildControls() {
        this.controls = document.createElement('div');
        TweenMax.set(this.controls, { y: this.config.contolsOffsetY });

        this.bar = document.createElement('div');
        this.bar.classList.add('bar');
        this.bar.innerHTML = '<div class="track"></div>';
        this.barFill = document.createElement('div');
        this.barFill.classList.add('fill');
        this.barFill.style.backgroundColor = this.config.colors[0];
        this.barIndicator = document.createElement('div');
        this.barIndicator.classList.add('indicator');
        this.barIndicator.style.backgroundColor = this.config.colors[0];
        this.bar.appendChild(this.barFill);
        this.bar.appendChild(this.barIndicator);
        Utils.hide(this.barIndicator);
        Utils.hide(this.bar);

        Utils.createStyle.call(
          this.component,
          COMPONENT_NAME,
          '.bar',
          'height:15px; position: absolute; top: -10px; left: 10px; cursor:pointer;',
          '.bar .track',
          'width:100%;height:1px; background-color: ' + this.config.colors[1] + ';position: absolute; top: 10px; left: 0;',
          '.bar .fill',
          'height:1px; position: absolute; top: 10px; left: 0;',
          '.bar .indicator',
          'width:10px;height:10px; border-radius:5px; position: absolute; top: 5px; left: 0px;background-color:' +
            this.config.colors[1] +
            ';pointer-events: none;'
        );

        if (this.config.controlsAutoHide) {
          this.controls.addEventListener(
            'mouseover',
            function() {
              TweenMax.to(this.controls, 0.3, { alpha: 1, ease: Cubic.easeOut });
            }.bind(this)
          );

          this.controls.addEventListener(
            'mouseout',
            function() {
              if (this.playing) {
                TweenMax.to(this.controls, 1, { alpha: 0, ease: Cubic.easeOut });
              }
            }.bind(this)
          );

          this.clickArea.addEventListener(
            'mouseover',
            function() {
              TweenMax.to(this.controls, 0.3, { alpha: 1, ease: Cubic.easeOut });
            }.bind(this)
          );

          this.clickArea.addEventListener(
            'mouseout',
            function() {
              if (this.playing) {
                TweenMax.to(this.controls, 1, { alpha: 0, ease: Cubic.easeOut });
              }
            }.bind(this)
          );
        }

        this.bar.addEventListener(
          'click',
          function(e) {
            var p = e.offsetX / this.bar.getBoundingClientRect().width;
            this.seek(this.video.getDuration() * p);
          }.bind(this)
        );

        this.bar.addEventListener(
          'mouseover',
          function() {
            Utils.show(this.barIndicator);
            this.barFill.seeking = true;
            this.barFill.current = this.barFill.style.width;
          }.bind(this)
        );

        this.bar.addEventListener(
          'mouseout',
          function() {
            this.barFill.seeking = false;
            Utils.hide(this.barIndicator);
            this.barFill.style.width = this.barFill.current;
          }.bind(this)
        );

        this.bar.addEventListener(
          'mousemove',
          function(e) {
            if (e.offsetX < this.bar.getBoundingClientRect().width - 6 && e.offsetX > 6)
              TweenMax.set(this.barIndicator, { x: e.offsetX - 6 });
            var p = e.offsetX / this.bar.getBoundingClientRect().width * 100;
            TweenMax.set(this.barFill, { width: p + '%' });
          }.bind(this)
        );

        this.playButton = new svgButton(null, 'M16,15 L16,35 24,30 24,19 M24,19 L24,30 35,25 35,25');
        this.playButton.icon = new Utils.SvgIcon(
          'svgIcon',
          'M16,15 L16,36 23,36 23,15 M28,15 L28,36 35,36 35,15',
          this.config.colors[0]
        );
        this.playButton.appendChild(this.playButton.icon);

        this.playButton.tween = {
          play: function() {
            this.icon.setAttributeNS(null, 'd', this.hover);
          }.bind(this.playButton),
          reverse: function() {
            this.icon.setAttributeNS(null, 'd', this.icon.getAttribute('data-original'));
          }.bind(this.playButton)
        };

        this.muteButton = new svgButton(null, 'M35,20 L46,31 M35,31 L46,20');
        this.muteButton.fill = new Utils.SvgIcon(
          '',
          'M13,20 L13,31 21,31 29,37 31,37 31,14 29,14 21,20 13,20 M35,20 L45,30',
          this.config.colors[0]
        );
        this.muteButton.appendChild(this.muteButton.fill);
        this.muteButton.icon = new Utils.SvgIcon('svgIcon', 'M35,20 A5,5 0 0,1 35,31', this.config.colors[0]);
        this.muteButton.icon.setAttribute('stroke', this.config.colors[0]);
        this.muteButton.icon.setAttribute('stroke-width', '3');
        this.muteButton.icon.setAttribute('fill-opacity', '0');
        this.muteButton.appendChild(this.muteButton.icon);

        this.muteButton.tween = {
          play: function() {
            this.icon.setAttributeNS(null, 'd', this.hover);
          }.bind(this.muteButton),
          reverse: function() {
            this.icon.setAttributeNS(null, 'd', this.icon.getAttribute('data-original'));
          }.bind(this.muteButton)
        };

        this.timerView = document.createElement('div');
        this.playButton.classList.add('playButton');
        this.playButton.classList.add('v_icon');
        this.muteButton.classList.add('muteButton');
        this.muteButton.classList.add('v_icon');
        this.timerView.className = 'timer';
        this.timerView.style.color = this.config.colors[0];

        this.controls.classList.add('controls');

        this.controls.appendChild(this.playButton);
        this.controls.appendChild(this.muteButton);
        this.controls.appendChild(this.timerView);
        this.controls.appendChild(this.bar);
        this.wrapper.appendChild(this.controls);

        if (Utils.isiOS) Utils.hide(this.muteButton);

        this.playButton.addEventListener('click', togglePlay.bind(this));
        this.playButton.addEventListener(
          'mouseover',
          function() {
            TweenMax.to(this.playButton.icon, 0.2, { fill: this.config.colors[1], ease: Quad.easeOut });
          }.bind(this)
        );
        this.playButton.addEventListener(
          'mouseout',
          function() {
            TweenMax.to(this.playButton.icon, 0.2, { fill: this.config.colors[0], ease: Quad.easeOut });
          }.bind(this)
        );

        this.muteButton.addEventListener('click', toggleMute.bind(this));
        this.muteButton.addEventListener(
          'mouseover',
          function() {
            TweenMax.to(this.muteButton.icon, 0.2, {
              fill: this.config.colors[1],
              stroke: this.config.colors[1],
              ease: Quad.easeOut
            });
            TweenMax.to(this.muteButton.fill, 0.2, { fill: this.config.colors[1], ease: Quad.easeOut });
          }.bind(this)
        );
        this.muteButton.addEventListener(
          'mouseout',
          function() {
            TweenMax.to(this.muteButton.icon, 0.2, { stroke: this.config.colors[0], ease: Quad.easeOut });
            TweenMax.to(this.muteButton.fill, 0.2, { fill: this.config.colors[0], ease: Quad.easeOut });
          }.bind(this)
        );

        if (this.config.customControlsMobile) {
          TweenMax.set([this.playButton, this.muteButton], { scale: 1.5 });
        }

        this.playButton.classList.remove('pause');
        this.playButton.tween.play();
      }

      function togglePlay() {
        if (this._video.paused) {
          this.resume();
        } else {
          this.pause();
          Utils.tracker('VIDEO_PAUSE', this.currentVideo.source, { time: this.video.getCurrentTime() });
        }
      }

      function toggleMute() {
        if (this.video.isMuted()) {
          this.unmute();
        } else {
          this.mute();
        }
      }

      function startTimer() {
        clearInterval(this.timer);
        this.playing = true;
        this.component.playing = true;
        this.timer = setInterval(
          function setInterval() {
            timeStep.call(this);
          }.bind(this),
          10
        );
        timeStep.call(this);
      }

      function timeStep() {
        if (this.video.getDuration()) {
          setTimeDisplay.call(this);
          var p = this.video.getCurrentTime() / this.video.getDuration();
          if (!this.barFill.seeking) this.barFill.style.width = p * 100 + '%';
        }

        this.component.dispatch('video-time', {
          currentTime: this.video.getCurrentTime(),
          duration: this.video.getDuration() || 0,
          target: this.component
        });

        switch (Math.round(p * 100)) {
          case 25:
            if (!this.currentVideo.firstQuart) {
              Utils.tracker('VIDEO_FIRST_QUART', this.currentVideo.source, { time: this.video.getCurrentTime() });
              this.currentVideo.firstQuart = true;
            }
            break;

          case 50:
            if (!this.currentVideo.secondQuart) {
              Utils.tracker('VIDEO_SECOND_QUART', this.currentVideo.source, { time: this.video.getCurrentTime() });
              this.currentVideo.secondQuart = true;
            }
            break;

          case 75:
            if (!this.currentVideo.thirdQuart) {
              Utils.tracker('VIDEO_THIRD_QUART', this.currentVideo.source, { time: this.video.getCurrentTime() });
              this.currentVideo.thirdQuart = true;
            }
            break;
        }
      }

      function setTimeDisplay(current) {
        this.timerView.innerHTML = this.timerView.innerHTML =
          Utils.timeFormat(current || Math.round(this.video.getCurrentTime())) +
          ' / ' +
          Utils.timeFormat(Math.round(this.video.getDuration()));
      }

      function setEvents() {
        this.clickArea.addEventListener('click', onVideoClick.bind(this));

        this.closeButton.addEventListener('click', this.close.bind(this));

        this.closeButton.addEventListener(
          'mouseover',
          function() {
            TweenMax.to(this.closeButtonSvg.fill, 0.3, { fill: this.config.closeColors[1], ease: Quad.easeOut });
            this.closeButtonSvg.cross.setAttribute('stroke', this.config.closeColors[0]);
          }.bind(this)
        );
        this.closeButton.addEventListener(
          'mouseout',
          function() {
            TweenMax.to(this.closeButtonSvg.fill, 0.3, { fill: this.config.closeColors[0], ease: Quad.easeOut });
            this.closeButtonSvg.cross.setAttribute('stroke', this.config.closeColors[1]);
          }.bind(this)
        );
      }

      function onVideoClick() {
        this.component.dispatch('video-click');
      }

      function onStateChanged(e) {
        switch (e.data != undefined ? e.data : e.type) {
          case 'ended':
            this.active = false;
            onVideoEnded.call(this);
            break;
          case 'loadeddata':
            if (!this.active || this.initPlay) {
              this.initPlay = false;
              onVideoPlay.call(this);
            }
            this.active = true;
            break;
          case 'pause':
            this.component.dispatch('video-pause');
            onVideoPause.call(this);
            break;
          case 'play':
            if (this.ended) onVideoPlay.call(this);
            this.ended = false;
            Utils.tracker('VIDEO_PLAY', this.currentVideo.source, { time: this.video.getCurrentTime() });
            this.component.dispatch('video-play');
            break;
        }
      }

      function onVideoEnded() {
        if (this.currentVideo.hideOnComplete) {
          this.hide();
        }

        this.stopTimer();

        this.initPlay = true;
        this.ended = true;
        this.playing = false;
        this.playButton.classList.remove('pause');
        this.playButton.tween.play();
        this.barFill.style.width = '100%';
        this.barFill.current = this.barFill.style.width;

        Utils.tracker('VIDEO_COMPLETE', this.currentVideo.source, { time: this.video.getCurrentTime() });
        this.component.dispatch('video-complete');
        this.currentVideo.completed++;
      }

      function onVideoPlay() {
        startTimer.call(this);
        Utils.show(this.container);
        this.playButton.classList.add('pause');
        this.playButton.tween.reverse();
        if (this.config.controlsAutoHide && this.config.controlsAutoHide[this.id]) {
          TweenMax.to(this.controls, 2, { alpha: 0, delay: 2, ease: Cubic.easeOut });
        }
        this.currentVideo.duration = this.video.duration;
        if (this.autoplay == true) {
          this.autoplay = false;
        }

        this.currentVideo.plays++;
      }

      function onVideoPause() {
        this.playButton.classList.remove('pause');
        this.playButton.tween.play();
      }
    }

    NetflixVideo.prototype.resize = function(size) {
      size = size || {};
      var i = this.config.size[this.id] ? this.id : 0;
      this.previousSize = { width: this.width, height: this.height };
      this.width = size.width || this.config.size[i].width;
      this.height = size.height || this.config.size[i].height;

      this.container.setAttribute('width', this.width);
      this.container.setAttribute('height', this.height);

      TweenMax.set(this.bar, { width: this.width - 20 });
      TweenMax.set([this.container, this._video, this.wrapper, this.component], { width: this.width, height: this.height });
    };

    NetflixVideo.prototype.setSource = function(id) {
      this.videoLoaded = this.currentVideo === this.sources[id];
      this.currentVideo = this.sources[id];
      this.currentVideo.firstQuart = false;
      this.currentVideo.secondQuart = false;
      this.currentVideo.thirdQuart = false;

      this.video.id = 'video_' + id;
      this.active = false;

      this.resize(this.config.size[id]);

      if (this.config.showBar[id] !== undefined) {
        if (this.config.showBar[id]) Utils.show(this.bar);
        else Utils.hide(this.bar);
      } else {
        if (this.config.showBar[0]) Utils.show(this.bar);
        else Utils.hide(this.bar);
      }

      if (!this.currentVideo.customControls) this.disableCustomControls();
      if (this.currentVideo.controls) this.enableControls();
      if (!this.currentVideo.controls) this.disableControls();
      if (this.currentVideo.customControls) this.enableCustomControls();

      this.playHistory = this.playHistory || [];
      this.playHistory.push(this.currentVideo);

      Utils.suppressLog = true;

      if (this.currentVideo.muted) {
        this.mute();
      } else {
        this.unmute();
      }

      this.timerView.innerHTML = '';
      this.video.cueVideoById(this.currentVideo.source);
    };

    NetflixVideo.prototype.play = function(id) {
      this.initPlay = true;

      if (id === -1) {
        this.autoplay = true;
      }

      if (!this.sources.length) return;

      id = this.sources[id] ? id : this.currentVideo ? this.currentVideo._id : 0;

      if (this.config.fullscreen[typeof this.config.fullscreen[id] === 'undefined' ? 0 : id] && id !== -1) {
        this.enterFullscreen();
      }

      this.load(id);

      this.videoPlays = this.videoPlays || {};
      this.videoPlays[id] = this.videoPlays[id] ? this.videoPlays[id] + 1 : 1;

      this.resume();
    };

    NetflixVideo.prototype.pause = function(time) {
      this.initPlay = true;
      this.video.pauseVideo();

      if (time !== null && time !== undefined) {
        this.seek(time);
      }

      this.playing = false;
      this.component.playing = false;
    };

    NetflixVideo.prototype.stop = function() {
      this.initPlay = true;
      if (this._video.ended) return;
      this.pause(0, false);
      this.active = false;

      Utils.tracker('VIDEO_STOP', this.currentVideo.source, { time: this.video.getCurrentTime() });
      Utils.suppressLog = true;

      this.stopTimer();
    };

    NetflixVideo.prototype.resume = function() {
      this.playing = true;
      this.component.playing = true;
      this.video.playVideo();
      this.playButton.classList.add('pause');
      this.playButton.tween.reverse();
    };

    NetflixVideo.prototype.seek = function(time) {
      this.video.seekTo(time || 0);
      this.barFill.current = this.barFill.style.width;
    };

    NetflixVideo.prototype.unmute = function() {
      this.video.unMute();
      this.currentVideo.muted = false;
      Utils.show(this.muteButton);
      this.muteButton.classList.add('unmute');
      this.muteButton.tween.reverse();
      Utils.tracker('VIDEO_UNMUTE', this.currentVideo.source, { time: this.video.getCurrentTime() });
    };

    NetflixVideo.prototype.mute = function() {
      this.video.mute();
      this.currentVideo.muted = true;
      this.muteButton.classList.remove('unmute');
      this.muteButton.tween.play();
      Utils.tracker('VIDEO_MUTE', this.currentVideo.source, { time: this.video.getCurrentTime() });
    };

    NetflixVideo.prototype.load = function(id) {
      if (!this.sources.length) return;

      this.show();

      this.setSource(id);

      if (this._video) this._video.load();
    };

    NetflixVideo.prototype.hide = function() {
      this.pause(null, false);
      Utils.hide(this.component);
      Utils.hide(this.container);
      Utils.hide(this.wrapper);
      this.stopTimer();
      this.active = false;
    };

    NetflixVideo.prototype.show = function() {
      Utils.show(this.component);
      Utils.show(this.wrapper);
      Utils.show(this.container);
    };

    NetflixVideo.prototype.close = function(e) {
      this.hide();
      if (this.currentVideo && this.currentVideo.source && e) {
        Utils.tracker('VIDEO_STOP', this.currentVideo.source, { time: this.video.getCurrentTime() });
      }
      this.component.dispatch('video-close');
    };

    NetflixVideo.prototype.enableCustomControls = function() {
      Utils.show(this.controls);
      Utils.show(this.clickArea);
      this._video.removeAttribute('controls');
    };

    NetflixVideo.prototype.disableCustomControls = function() {
      Utils.hide(this.controls);
      Utils.hide(this.clickArea);
      this._video.setAttribute('controls', 'controls');
    };

    NetflixVideo.prototype.enableControls = function() {
      Utils.hide(this.clickArea);
      this._video.setAttribute('controls', 'controls');
    };

    NetflixVideo.prototype.disableControls = function() {
      Utils.show(this.clickArea);
      this._video.removeAttribute('controls');
    };

    return NetflixVideo;
  })();

  // Component Definition
  (function() {
    var VideoComponent = function() {
      var self = Utils.reflectConstruct(HTMLElement, [], this.constructor);
      self._attached = false;
      self._hasInited = false;
      return self;
    };

    VideoComponent.prototype = Object.create(HTMLElement.prototype, {
      disconnectedCallback: {
        value: function() {
          this._attached = false;
        }
      },
      connectedCallback: {
        value: function() {
          this._attached = true;

          if (this._hasInited) {
            return;
          }

          this._hasInited = true;

          var videoComponent = this;

          this.toggle = true;
          this.width = parseInt(this.getAttribute('width') || this.offsetWidth);
          this.height = parseInt(this.getAttribute('height') || this.offsetHeight);

          var elements = document.querySelectorAll('netflix-video');

          for (var i = 0; i < elements.length; i++) {
            elements[i].setAttribute('video_id', i + 1);
            elements[i].style.position = 'absolute';
          }

          var config = (this.config = {});
          config.size = [
            {
              width: this.width,
              height: this.height
            }
          ];

          config.sources = [this.getAttribute('source')];
          config.closeButtonSize = 20;
          config.colors = [this.getAttribute('color-1'), this.getAttribute('color-2')];
          config.showBar = [true];
          config.controlsAutoHide = [this.hasAttribute('controlsAutoHide')];
          config.closeColors = [
            this.getAttribute('close-color-1') || this.getAttribute('color-1'),
            this.getAttribute('close-color-2') || this.getAttribute('color-2')
          ];
          config.hideOnComplete = [this.hasAttribute('hideOnComplete')];
          config.customControls = [this.hasAttribute('controls')];
          config.controls = [false];
          config.fullscreen = [this.hasAttribute('fullscreen')];
          config.muted = [this.hasAttribute('muted')];
          config.autoplay = this.hasAttribute('autoplay');
          config.contolsOffsetY = this.getAttribute('controls-offset-y') || 0;

          if (config.autoplay) {
            config.muted[0] = true;
          }

          if (Utils.isMobile) {
            config.controls = [true];
            config.customControls = [false];
          }

          if (!this.getAttribute('data-dynamic-key')) {
            window.addEventListener(
              'adinitialized',
              function() {
                this.video = new NetflixVideo(this, config);
              }.bind(this),
              false
            );
          } else {
            var MonetComponent = document.querySelector('monet-integrator');
            if (MonetComponent) {
              MonetComponent.register(this);
              MonetComponent.getMonetData().then(
                function(data) {
                  var d = videoComponent.getAttribute('data-dynamic-key');

                  try {
                    if (setVideoToggle(data)) {
                      config.sources = getVideoNode(data, d);
                      this.video = new NetflixVideo(this, config);
                      this.dispatchEvent(new CustomEvent('ready'));
                    }
                  } catch (e) {
                    console.error('Monet dynamic ID:', d, 'not found in JSON. Trying backup');

                    MonetComponent.getBackupMonetData().then(
                      function(backupData) {
                        if (setVideoToggle(backupData)) {
                          config.sources = getVideoNode(backupData, d);
                          this.video = new NetflixVideo(this, config);
                          this.dispatchEvent(new CustomEvent('ready'));
                        }
                      }.bind(this),
                      function(error) {
                        console.error('Failed to load backup Monet data', error);
                      }
                    );
                  }
                }.bind(this),
                function(error) {
                  console.error('Failed to load Monet data', error);
                }
              );
            } else {
              this.video = new NetflixVideo(this, config);
              this.dispatchEvent(new CustomEvent('ready'));
            }
          }

          function setVideoToggle(data) {
            var d = videoComponent.getAttribute('data-dynamic-key');
            if (data.rootAssets['bool.Toggle_' + d]) {
              if (!data.rootAssets['bool.Toggle_' + d].value) {
                videoComponent.dispatchEvent(new CustomEvent('ready'));
                return (videoComponent.toggle = false);
              }
            }
            return true;
          }

          function getVideoNode(data, key) {
            var r = data.rootAssets;
            var types = ['video', 'url'];
            for (var i = 0; i < 2; i++) {
              var combo = types[i] + '.' + key;
              if (r[combo]) {
                return [r[combo].url];
              }
            }
            throw new Error('Monet dynamic ID: ' + key + ' not found in backup JSON');
          }
        },
        enumerable: true
      },

      play: {
        value: function() {
          if (!this.toggle) {
            this.dispatch('video-complete');
          }
          if (this.video) {
            this.video.play();
          }
        }
      },

      pause: {
        value: function() {
          if (this.video && this.toggle) {
            this.video.pause();
          }
        }
      },

      close: {
        value: function(e) {
          if (this.video && this.toggle) {
            this.video.close(e);
          }
        }
      },

      mute: {
        value: function() {
          if (this.video && this.toggle) {
            this.video.mute();
          }
        }
      },

      unmute: {
        value: function() {
          if (this.video && this.toggle) {
            this.video.unmute();
          }
        }
      },

      seek: {
        value: function(t) {
          if (this.video && this.toggle) {
            this.video.seek(t);
          }
        }
      },

      resize: {
        value: function(w, h) {
          if (this.video && this.toggle) {
            this.video.resize({ width: w, height: h });
          }
        }
      },

      dispatch: {
        value: function(e, d) {
          var customEvent = document.createEvent('CustomEvent');
          customEvent.initCustomEvent(e, !0, !0, d);
          this.dispatchEvent(customEvent);
        }
      },

      preview: {
        value: function() {
          this.setAttribute('width', 300);
          this.setAttribute('height', 300);
          this.setAttribute('color-1', '#E50914');
          this.setAttribute('color-2', '#F5F5F1');
          this.setAttribute('close-color-1', '#E50914');
          this.setAttribute('close-color-2', '#F5F5F1');
          this.setAttribute('data-dynamic-key', 'Trailer');
          this.setAttribute('controls', 'true');
          this.setAttribute('autoplay', 'true');
          this.setAttribute('source', '//ae.nflximg.net/monet/video/fpo/1x1.mp4');
        }
      }
    });

    VideoComponent.prototype.constructor = VideoComponent;
    Object.setPrototypeOf(VideoComponent, HTMLElement);
    customElements.define(COMPONENT_NAME, VideoComponent);
  })();
})();
